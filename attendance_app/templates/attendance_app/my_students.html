{% extends "attendance_app/teacher_base.html" %}
{% block title %}My Students{% endblock %}

{% block content %}

<div class="card shadow-sm">
    <div class="card-body">

        <h4 class="mb-4">
            My Students : {{ classroom.name }} ({{ classroom.year }})
        </h4>

        <!-- ================= SEARCH & EXPORT ================= -->
        <form method="get" class="row g-2 align-items-end mb-3">
            <div class="col-12 col-md-4">
                <label class="form-label">Search Student</label>
                <input type="text"
                       name="search"
                       value="{{ search }}"
                       class="form-control"
                       placeholder="Admission number or name">
            </div>

            <div class="col-12 col-md-2">
                <button class="btn btn-primary w-100">
                    Search
                </button>
            </div>

            <div class="col-12 col-md-6 text-md-end">
                <label class="form-label d-none d-md-block">&nbsp;</label>
                <div class="d-flex gap-2 justify-content-md-end">
                    <a href="{% url 'export_students_excel' %}" class="btn btn-success btn-sm w-100 w-md-auto">
                        Excel
                    </a>
                    <a href="{% url 'export_students_pdf' %}" class="btn btn-danger btn-sm w-100 w-md-auto">
                        PDF
                    </a>
                </div>
            </div>
        </form>

        <!-- ================= TABLE ================= -->
        <div class="table-responsive">
            <table class="table table-bordered table-striped table-hover align-middle">
                <thead style="background-color:#4f46e5;color:#fff;">
                    <tr>
                        <th>No</th>
                        <th>Admission No</th>
                        <th>Student Name</th>
                        <th class="d-none d-md-table-cell">Email</th>
                        <th class="d-none d-md-table-cell">Phone</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr>
                        <td>{{ students.start_index|add:forloop.counter0 }}</td>
                        <td>{{ student.admission_number }}</td>
                        <td>{{ student.user.get_full_name }}</td>
                        <td class="d-none d-md-table-cell">{{ student.user.email|default:"—" }}</td>
                        <td class="d-none d-md-table-cell">{{ student.phone_number|default:"—" }}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-primary w-100 w-md-auto"
                                    data-bs-toggle="modal"
                                    data-bs-target="#studentModal"
                                    data-id="{{ student.id }}">
                                View
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            No students found
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- ================= PAGINATION ================= -->
        {% if students.has_other_pages %}
        <nav class="mt-3">
            <ul class="pagination justify-content-center flex-wrap">

                {% if students.has_previous %}
                <li class="page-item">
                    <a class="page-link"
                       href="?search={{ search }}&page={{ students.previous_page_number }}">
                        &laquo;
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                {% endif %}

                {% for page in students.paginator.page_range %}
                    {% if page >= students.number|add:-2 and page <= students.number|add:2 %}
                        {% if page == students.number %}
                        <li class="page-item active">
                            <span class="page-link">{{ page }}</span>
                        </li>
                        {% else %}
                        <li class="page-item">
                            <a class="page-link" href="?search={{ search }}&page={{ page }}">{{ page }}</a>
                        </li>
                        {% endif %}
                    {% endif %}
                {% endfor %}

                {% if students.has_next %}
                <li class="page-item">
                    <a class="page-link"
                       href="?search={{ search }}&page={{ students.next_page_number }}">
                        &raquo;
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                {% endif %}

            </ul>
        </nav>
        {% endif %}

    </div>
</div>

<!-- ================= STUDENT MODAL ================= -->
<div class="modal fade" id="studentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content"></div>
    </div>
</div>

<!-- ================= SCRIPT ================= -->
<script>
const modal = document.getElementById("studentModal");

modal.addEventListener("show.bs.modal", function (event) {
    const button = event.relatedTarget;
    const studentId = button.getAttribute("data-id");

    fetch(`/student-profile/${studentId}/`)
        .then(response => response.text())
        .then(html => {
            modal.querySelector(".modal-content").innerHTML = html;
        });
});
</script>

<!-- ================= STYLES ================= -->
<style>
.table-hover tbody tr:hover {
    background-color: rgba(79,70,229,0.08);
}

.table-bordered th,
.table-bordered td {
    border-color:#e5e7eb;
}

.btn-primary,
.btn-success,
.btn-danger {
    border-radius:6px;
    font-weight:500;
}

.pagination .page-item.active .page-link {
    background:#4f46e5;
    border-color:#4f46e5;
    color:#fff;
}

.pagination .page-link:hover {
    color:#4f46e5;
}

/* MOBILE */
@media (max-width:768px){
    h4{font-size:1.1rem}
    .table th,.table td{
        font-size:.85rem;
        padding:.45rem;
    }
}
</style>

{% endblock %}
