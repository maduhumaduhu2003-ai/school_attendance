{% extends 'attendance_app/teacher_base.html' %}
{% block title %}View Attendance{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-body">
        <h4 class="mb-4">Attendance Records : {{ classroom.name }} ({{ classroom.year }})</h4>

        <!-- Summary Section -->
        <div class="row mb-4">
            <div class="col-md-2"><strong>Total Students:</strong> {{ students_count }}</div>
            <div class="col-md-2 text-success"><strong>Present:</strong> {{ total_present }} ({{ present_percentage }}%)</div>
            <div class="col-md-2 text-danger"><strong>Absent:</strong> {{ total_absent }} ({{ absent_percentage }}%)</div>
            <div class="col-md-2 text-warning"><strong>Sick:</strong> {{ total_sick }} ({{ sick_percentage }}%)</div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <strong>Male Students ({{ male_count }}):</strong>
                Present: {{ male_present }} ({{ male_present_pct }}%), 
                Absent: {{ male_absent }} ({{ male_absent_pct }}%), 
                Sick: {{ male_sick }} ({{ male_sick_pct }}%)
            </div>
            <div class="col-md-6">
                <strong>Female Students ({{ female_count }}):</strong>
                Present: {{ female_present }} ({{ female_present_pct }}%), 
                Absent: {{ female_absent }} ({{ female_absent_pct }}%), 
                Sick: {{ female_sick }} ({{ female_sick_pct }}%)
            </div>
        </div>

        <!-- Filter by Date -->
        <form method="GET" class="row g-2 align-items-end mb-3">
            <div class="col-md-4">
                <label class="form-label">Select Date</label>
                <input type="date" name="date" value="{{ selected_date }}" class="form-control">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">View Attendance</button>
            </div>
        </form>

        <!-- Attendance Table -->
        <div class="table-responsive">
            <table class="table table-bordered table-striped table-hover align-middle">
                <thead style="background-color: #4f46e5; color: #fff;">
                    <tr>
                        <th>No</th>
                        <th>Admission No</th>
                        <th>Student Name</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in attendance_records %}
                    <tr data-id="{{ record.id }}">
                        <td>{{ forloop.counter }}</td>
                        <td>{{ record.student.admission_number }}</td>
                        <td>{{ record.student.user.first_name }} {{ record.student.user.last_name }}</td>
                        <td>{{ record.date|date:"M d, Y" }}</td>
                        <td class="status-cell">
                            {% if record.status == 'absent' %}
                                <span class="badge bg-danger">Absent</span>
                            {% elif record.status == 'sick' %}
                                <span class="badge bg-warning text-dark">Sick</span>
                            {% else %}
                                <span class="badge bg-success">Present</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if record.date == today %}
                                <button 
                                    class="btn btn-sm btn-warning edit-btn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editAttendanceModal"
                                    data-id="{{ record.id }}"
                                >Edit</button>
                            {% else %}
                                <button class="btn btn-sm btn-secondary" disabled>Edit</button>
                            {% endif %}

                            <button 
                                class="btn btn-sm btn-danger delete-btn" 
                                data-id="{{ record.id }}"
                            >Delete</button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted">No attendance records found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if attendance_records.has_other_pages %}
        <nav class="mt-3">
            <ul class="pagination justify-content-center">
                {% if attendance_records.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?date={{ selected_date }}&page={{ attendance_records.previous_page_number }}">Previous</a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">Previous</span></li>
                {% endif %}

                {% for num in attendance_records.paginator.page_range %}
                    {% if attendance_records.number == num %}
                        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% elif num > attendance_records.number|add:"-3" and num < attendance_records.number|add:"3" %}
                        <li class="page-item">
                            <a class="page-link" href="?date={{ selected_date }}&page={{ num }}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if attendance_records.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?date={{ selected_date }}&page={{ attendance_records.next_page_number }}">Next</a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">Next</span></li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editAttendanceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content"></div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this attendance record?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container (Top Right) -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 11000">
    <div id="toastMsg" class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
        <div class="d-flex">
            <div class="toast-body" id="toastBody"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<script>
let recordToDelete = null;

// Edit modal logic
const editModal = document.getElementById('editAttendanceModal');
editModal.addEventListener('show.bs.modal', function(event) {
    const button = event.relatedTarget;
    const recordId = button.getAttribute('data-id');

    fetch(`/edit_attendance/${recordId}/`)
        .then(res => res.text())
        .then(html => {
            editModal.querySelector('.modal-content').innerHTML = html;

            const form = editModal.querySelector('#editAttendanceForm');
            if(form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(form);

                    fetch(`/edit_attendance/${recordId}/`, {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(res => res.json())
                    .then(data => {
                        showToast(data.success, data.message);

                        if(data.success) {
                            const row = document.querySelector(`tr[data-id='${recordId}']`);
                            const statusCell = row.querySelector('.status-cell span');

                            if(data.message.includes('Present')) {
                                statusCell.className = 'badge bg-success';
                                statusCell.innerText = 'Present';
                            } else if(data.message.includes('Absent')) {
                                statusCell.className = 'badge bg-danger';
                                statusCell.innerText = 'Absent';
                            } else if(data.message.includes('Sick')) {
                                statusCell.className = 'badge bg-warning text-dark';
                                statusCell.innerText = 'Sick';
                            }

                            setTimeout(() => {
                                const modalInstance = bootstrap.Modal.getInstance(editModal);
                                modalInstance.hide();
                            }, 1000);
                        }
                    });
                });
            }
        });
});

// Delete button logic with modal
document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        recordToDelete = this.dataset.id;
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        deleteModal.show();
    });
});

document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    if(!recordToDelete) return;

    fetch(`/delete_attendance/${recordToDelete}/`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(res => res.json())
    .then(data => {
        showToast(data.success, data.message);
        if(data.success) {
            const row = document.querySelector(`tr[data-id='${recordToDelete}']`);
            if(row) row.remove();
        }
        const modalInstance = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
        modalInstance.hide();
        recordToDelete = null;
    });
});

// Toast function
function showToast(success, msg) {
    const toastEl = document.getElementById('toastMsg');
    const toastBody = document.getElementById('toastBody');
    toastBody.innerText = msg;

    toastEl.classList.remove('bg-success', 'bg-danger');
    toastEl.classList.add(success ? 'bg-success' : 'bg-danger');

    const toast = new bootstrap.Toast(toastEl);
    toast.show();
}
</script>

<style>
.table-hover tbody tr:hover { background-color: rgba(79, 70, 229, 0.08); }
.table-bordered th, .table-bordered td { border-color: #e5e7eb; }
input[type="radio"] { margin-right: 5px; cursor: pointer; }
.badge { font-size: 0.85rem; padding: 0.5em 0.65em; border-radius: 6px; }
</style>
{% endblock %}
