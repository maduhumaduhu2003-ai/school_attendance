{% extends 'attendance_app/teacher_base.html' %}
{% block title %}View Attendance{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-body">

        <h4 class="mb-4">
            Attendance Records : {{ classroom.name }} ({{ classroom.year }})
        </h4>

        <!-- ================= EXPORT BUTTONS ================= -->
<div class="d-flex gap-2 mb-3 flex-wrap">
    <a href="{% url 'attendance_export_pdf' %}?date={{ selected_date }}"
       class="btn btn-danger btn-sm">
        Export PDF
    </a>

    <a href="{% url 'attendance_export_excel' %}?date={{ selected_date }}"
       class="btn btn-success btn-sm">
        Export Excel
    </a>
</div>


        <!-- ================= SUMMARY ================= -->
        <div class="row g-2 mb-4 summary-box">
            <div class="col-6 col-md-2"><strong>Total:</strong> {{ students_count }}</div>
            <div class="col-6 col-md-2 text-success"><strong>Present:</strong> {{ total_present }} ({{ present_percentage }}%)</div>
            <div class="col-6 col-md-2 text-danger"><strong>Absent:</strong> {{ total_absent }} ({{ absent_percentage }}%)</div>
            <div class="col-6 col-md-2 text-warning"><strong>Sick:</strong> {{ total_sick }} ({{ sick_percentage }}%)</div>
        </div>

        <div class="row g-2 mb-4 gender-summary">
            <div class="col-md-6">
                <strong>Male ({{ male_count }}):</strong><br>
                Present {{ male_present }} ({{ male_present_pct }}%) |
                Absent {{ male_absent }} ({{ male_absent_pct }}%) |
                Sick {{ male_sick }} ({{ male_sick_pct }}%)
            </div>
            <div class="col-md-6">
                <strong>Female ({{ female_count }}):</strong><br>
                Present {{ female_present }} ({{ female_present_pct }}%) |
                Absent {{ female_absent }} ({{ female_absent_pct }}%) |
                Sick {{ female_sick }} ({{ female_sick_pct }}%)
            </div>
        </div>

        <!-- ================= FILTER ================= -->
        <form method="GET" class="row g-2 align-items-end mb-3">
            <div class="col-12 col-md-4">
                <label class="form-label">Select Date</label>
                <input type="date" name="date" value="{{ selected_date }}" class="form-control">
            </div>
            <div class="col-12 col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    View Attendance
                </button>
            </div>
        </form>

        <!-- ================= TABLE ================= -->
        <div class="table-responsive">
            <table class="table table-bordered table-striped table-hover align-middle">
                <thead style="background-color: #4f46e5; color: #fff;">
                    <tr>
                        <th>No</th>
                        <th>Admission No</th>
                        <th>Student</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in attendance_records %}
                    <tr data-id="{{ record.id }}">
                        <td>{{ forloop.counter }}</td>
                        <td>{{ record.student.admission_number }}</td>
                        <td>{{ record.student.user.get_full_name }}</td>
                        <td>{{ record.date|date:"M d, Y" }}</td>
                        <td class="status-cell">
                            {% if record.status == 'absent' %}
                                <span class="badge bg-danger">Absent</span>
                            {% elif record.status == 'sick' %}
                                <span class="badge bg-warning text-dark">Sick</span>
                            {% else %}
                                <span class="badge bg-success">Present</span>
                            {% endif %}
                        </td>
                        <td class="text-center action-btns">
                            {% if record.date == today %}
                                <button 
                                    class="btn btn-sm btn-warning edit-btn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editAttendanceModal"
                                    data-id="{{ record.id }}"
                                >Edit</button>
                            {% else %}
                                <button class="btn btn-sm btn-secondary" disabled>Edit</button>
                            {% endif %}

                            <button 
                                class="btn btn-sm btn-danger delete-btn mt-1 mt-md-0"
                                data-id="{{ record.id }}"
                            >Delete</button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            No attendance records found
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- ================= PAGINATION ================= -->
        {% if attendance_records.has_other_pages %}
        <nav class="mt-3">
            <ul class="pagination justify-content-center flex-wrap">
                {% if attendance_records.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?date={{ selected_date }}&page={{ attendance_records.previous_page_number }}">Previous</a>
                </li>
                {% endif %}

                <li class="page-item active">
                    <span class="page-link">
                        {{ attendance_records.number }} / {{ attendance_records.paginator.num_pages }}
                    </span>
                </li>

                {% if attendance_records.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?date={{ selected_date }}&page={{ attendance_records.next_page_number }}">Next</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- ================= MODALS ================= -->
<div class="modal fade" id="editAttendanceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content"></div>
    </div>
</div>

<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Delete</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this attendance record?
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- ================= TOAST ================= -->
<div class="position-fixed top-0 end-0 p-3" style="z-index:11000">
    <div id="toastMsg" class="toast text-white border-0" data-bs-delay="3000">
        <div class="d-flex">
            <div class="toast-body" id="toastBody"></div>
            <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<!-- ================= SCRIPTS (UNCHANGED LOGIC) ================= -->
<script>
let recordToDelete = null;

/* EDIT */
const editModal = document.getElementById('editAttendanceModal');
editModal.addEventListener('show.bs.modal', function(event) {
    const recordId = event.relatedTarget.getAttribute('data-id');

    fetch(`/edit_attendance/${recordId}/`)
        .then(res => res.text())
        .then(html => {
            editModal.querySelector('.modal-content').innerHTML = html;

            const form = editModal.querySelector('#editAttendanceForm');
            if(form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(form);

                    fetch(`/edit_attendance/${recordId}/`, {
                        method: 'POST',
                        body: formData,
                        headers: {'X-Requested-With':'XMLHttpRequest'}
                    })
                    .then(res => res.json())
                    .then(data => {
                        showToast(data.success, data.message);
                        if(data.success) location.reload();
                    });
                });
            }
        });
});

/* DELETE */
document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        recordToDelete = this.dataset.id;
        new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
    });
});

document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    fetch(`/delete_attendance/${recordToDelete}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With':'XMLHttpRequest'
        }
    })
    .then(res => res.json())
    .then(data => {
        showToast(data.success, data.message);
        if(data.success) document.querySelector(`tr[data-id='${recordToDelete}']`)?.remove();
        bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
    });
});

/* TOAST */
function showToast(success, msg) {
    const toastEl = document.getElementById('toastMsg');
    document.getElementById('toastBody').innerText = msg;
    toastEl.className = `toast text-white ${success ? 'bg-success' : 'bg-danger'}`;
    new bootstrap.Toast(toastEl).show();
}
</script>

<!-- ================= STYLES ================= -->
<style>
.table-hover tbody tr:hover { background: rgba(79,70,229,.08); }
.table-bordered th, .table-bordered td { border-color:#e5e7eb; }
.badge { font-size:.85rem; border-radius:6px; }

/* MOBILE */
@media (max-width:768px){
    h4{font-size:1.1rem}
    .summary-box div{font-size:.85rem}
    .gender-summary{font-size:.85rem}
    .table th,.table td{font-size:.8rem;padding:.45rem}
    .action-btns button{width:100%}
}
</style>

{% endblock %}
